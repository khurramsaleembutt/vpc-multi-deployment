name: EcommerceApp Infrastructure Pipeline

on:
  pull_request:
    branches: [main]
    paths: ['environments/**', 'modules/**', '.github/workflows/ecommerce-pipeline.yml']
  push:
    branches: [main]
    paths: ['environments/**', 'modules/**', '.github/workflows/ecommerce-pipeline.yml']

env:
  TF_VERSION: 1.10.0

permissions:
  id-token: write
  contents: read
  pull-requests: write
  issues: write
  security-events: write

jobs:
  # ============================================================================
  # VALIDATION & SECURITY SCANNING
  # ============================================================================
  terraform-validate:
    name: Validate & Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Terraform Format
      run: |
        terraform fmt -recursive
        terraform fmt -check -recursive
    
    - name: Terraform Validate
      run: |
        # Validate dev-account1-us-east-1 only
        terraform -chdir=environments/dev-account1-us-east-1 init -backend=false
        terraform -chdir=environments/dev-account1-us-east-1 validate
        
        # Other environments commented out
        # terraform -chdir=environments/dev-account1-us-west-2 init -backend=false
        # terraform -chdir=environments/dev-account1-us-west-2 validate
        # terraform -chdir=environments/prod-account1-us-east-1 init -backend=false
        # terraform -chdir=environments/prod-account1-us-east-1 validate
        # terraform -chdir=environments/prod-account1-us-west-2 init -backend=false
        # terraform -chdir=environments/prod-account1-us-west-2 validate
    
    - name: Security Scan
      uses: bridgecrewio/checkov-action@master
      with:
        directory: .
        framework: terraform
        output_format: sarif
        output_file_path: checkov-results.sarif
        soft_fail: true
        skip_check: CKV_AWS_135,CKV2_AWS_12
    
    - name: Upload Security Results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: checkov-results.sarif

  # ============================================================================
  # DEV ENVIRONMENT PLANNING
  # ============================================================================
  dev-plan:
    name: Dev Plan
    runs-on: ubuntu-latest
    needs: terraform-validate
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT1 }}
        aws-region: us-east-1
        role-session-name: terraform-dev-us-east-1
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
    
    - name: Terraform Plan
      working-directory: ./environments/dev-account1-us-east-1
      run: |
        terraform init
        sed -i 's/aws_profile = .*/# aws_profile removed for CI\/CD/' terraform.tfvars
        sed -i 's/profile = var.aws_profile/# profile removed for CI\/CD/' main.tf
        terraform plan -var-file="terraform.tfvars" -out=tfplan -detailed-exitcode
        terraform show -json tfplan > plan.json
    
    - name: Cost Estimation
      uses: infracost/infracost-action@v1
      with:
        api_key: ${{ secrets.INFRACOST_API_KEY }}
        path: ./environments/dev-account1-us-east-1/plan.json
        format: json
        out_file: /tmp/infracost.json
    
    - name: Plan Summary Comment
      uses: actions/github-script@v6
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const plan = fs.readFileSync('./environments/dev-account1-us-east-1/plan.json', 'utf8');
          const planData = JSON.parse(plan);
          
          const summary = `
          ## ðŸ“‹ Terraform Plan Summary - dev-account1-us-east-1
          
          **Resources:**
          - ðŸŸ¢ **Add:** ${planData.resource_changes?.filter(r => r.change.actions.includes('create')).length || 0}
          - ðŸŸ¡ **Change:** ${planData.resource_changes?.filter(r => r.change.actions.includes('update')).length || 0}
          - ðŸ”´ **Destroy:** ${planData.resource_changes?.filter(r => r.change.actions.includes('delete')).length || 0}
          
          **EcommerceApp Infrastructure Pipeline Ready! ðŸš€**
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });
