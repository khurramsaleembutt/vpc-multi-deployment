name: Test Remote State - Account 1 Plan Only

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'dev-account1-us-east-1'
        type: choice
        options:
        - dev-account1-us-east-1
        - dev-account1-us-west-2
      action:
        description: 'Action to perform'
        required: true
        default: 'plan'
        type: choice
        options:
        - plan
        - apply
        - destroy

env:
  TF_VERSION: "1.6.0"

permissions:
  id-token: write
  contents: read

jobs:
  test-remote-state-plan:
    name: Test Remote State Plan
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'plan' || github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials Account 1
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT1 }}
        aws-region: ${{ contains(github.event.inputs.environment, 'east') && 'us-east-1' || 'us-west-2' }}
        role-session-name: terraform-test-${{ github.event.inputs.environment }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Test S3 and DynamoDB Access
      run: |
        echo "Testing S3 bucket access..."
        aws s3 ls s3://terraform-state-vpc-093285711854/ || echo "S3 access failed"
        
        echo "Testing DynamoDB table access..."
        aws dynamodb describe-table --table-name terraform-locks-vpc --region us-east-1 || echo "DynamoDB access failed"

    - name: Terraform Init (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        echo "Testing remote state backend initialization..."
        terraform init

    - name: Terraform Plan (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        # Remove AWS profile for CI/CD (use OIDC credentials instead)
        sed -i 's/aws_profile = .*/# aws_profile removed for CI\/CD/' terraform.tfvars
        sed -i 's/profile = var.aws_profile/# profile removed for CI\/CD/' main.tf
        
        echo "Running terraform plan with remote state..."
        terraform plan -var-file="terraform.tfvars"

  test-remote-state-apply:
    name: Test Remote State Apply
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'apply'
    needs: test-remote-state-plan
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials Account 1
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT1 }}
        aws-region: ${{ contains(github.event.inputs.environment, 'east') && 'us-east-1' || 'us-west-2' }}
        role-session-name: terraform-test-${{ github.event.inputs.environment }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        echo "Initializing remote state backend..."
        terraform init

    - name: Terraform Apply (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        # Remove AWS profile for CI/CD (use OIDC credentials instead)
        sed -i 's/aws_profile = .*/# aws_profile removed for CI\/CD/' terraform.tfvars
        sed -i 's/profile = var.aws_profile/# profile removed for CI\/CD/' main.tf
        
        echo "Running terraform apply with remote state..."
        terraform apply -var-file="terraform.tfvars" -auto-approve

    - name: Verify Remote State
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        echo "Checking state in S3..."
        aws s3 ls s3://terraform-state-vpc-093285711854/vpc/${{ github.event.inputs.environment }}/
        
        echo "Listing resources in state..."
        terraform state list

    - name: Output Summary
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: terraform output deployment_summary

  test-remote-state-destroy:
    name: Test Remote State Destroy
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    needs: test-remote-state-plan
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure AWS Credentials Account 1
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN_ACCOUNT1 }}
        aws-region: ${{ contains(github.event.inputs.environment, 'east') && 'us-east-1' || 'us-west-2' }}
        role-session-name: terraform-test-${{ github.event.inputs.environment }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Terraform Init (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        echo "Initializing remote state backend for destroy..."
        terraform init

    - name: Terraform Destroy (Remote State)
      working-directory: ./environments/${{ github.event.inputs.environment }}
      run: |
        # Remove AWS profile for CI/CD (use OIDC credentials instead)
        sed -i 's/aws_profile = .*/# aws_profile removed for CI\/CD/' terraform.tfvars
        sed -i 's/profile = var.aws_profile/# profile removed for CI\/CD/' main.tf
        
        echo "Running terraform destroy with remote state..."
        terraform destroy -var-file="terraform.tfvars" -auto-approve

    - name: Verify Destruction
      run: |
        echo "Verifying resources are destroyed..."
        VPC_COUNT=$(aws ec2 describe-vpcs --filters "Name=tag:Environment,Values=${{ github.event.inputs.environment }}" --query 'length(Vpcs)' --output text)
        if [ "$VPC_COUNT" = "0" ]; then
          echo "✅ All VPCs destroyed successfully"
        else
          echo "⚠️ Warning: $VPC_COUNT VPCs still exist"
        fi
